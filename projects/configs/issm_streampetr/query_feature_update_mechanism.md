# Query å’Œ Feature åŒé‡æ›´æ–°æœºåˆ¶è¯¦è§£

## ğŸ¯ æ ¸å¿ƒæ€æƒ³

åœ¨ ISSM-StreamPETR ä¸­ï¼Œ**Query å’Œ Feature åŒæ—¶æ¼”è¿›**ï¼Œè¿™æ˜¯åŒºåˆ«äºä¼ ç»Ÿ Attention æœºåˆ¶çš„å…³é”®åˆ›æ–°ï¼š

- **ä¼ ç»Ÿ Attention**: Query æŸ¥è¯¢ Featureï¼ŒFeature ä¿æŒä¸å˜
- **ISSM**: Query å’Œ Feature åœ¨äº¤äº’è¿‡ç¨‹ä¸­**ç›¸äº’å½±å“ã€å…±åŒæ¼”è¿›**

---

## ğŸ“ æ•°å­¦åŸç†

### SSM (çŠ¶æ€ç©ºé—´æ¨¡å‹) åŸºæœ¬å…¬å¼

```
h_t = AÂ·h_{t-1} + BÂ·x_t     (çŠ¶æ€æ›´æ–°)
y_t = CÂ·h_t                  (è¾“å‡ºç”Ÿæˆ)
```

åœ¨ ISSM-StreamPETR ä¸­ï¼š
- **h (éšçŠ¶æ€)** = Queryï¼ˆç›®æ ‡æ£€æµ‹çŠ¶æ€ï¼‰
- **x (è¾“å…¥)** = Featureï¼ˆå›¾åƒç‰¹å¾ï¼‰
- **y (è¾“å‡º)** = å‡€åŒ–åçš„ Feature
- **A, B, C, Î”** = ç”± 3D è·ç¦»åŠ¨æ€ç”Ÿæˆçš„å‚æ•°

---

## ğŸ”„ å®Œæ•´æ›´æ–°æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šè¾“å…¥å‡†å¤‡
```python
# è¾“å…¥
queries: [B, N_q, D]      # N_q ä¸ª Queryï¼Œæ¯ä¸ªç»´åº¦ D
anchors: [B, N_q, 3]      # æ¯ä¸ª Query çš„ 3D é”šç‚¹
features: [B, L, D]       # L ä¸ªåƒç´ çš„å›¾åƒç‰¹å¾
coords_3d: [B, L, 3]      # æ¯ä¸ªåƒç´ çš„ 3D åæ ‡
```

### ç¬¬äºŒæ­¥ï¼šè®¡ç®— 3D ç©ºé—´è·ç¦»
```python
# è®¡ç®—æ¯ä¸ª Query åˆ°æ¯ä¸ªåƒç´ çš„ 3D è·ç¦»
diff = coords_3d.unsqueeze(1) - anchors.unsqueeze(2)  # [B, N_q, L, 3]

# è·ç¦»çš„ç‰©ç†æ„ä¹‰ï¼š
# - è¿‘è·ç¦» â†’ å¼ºäº¤äº’ï¼ˆQuery å…³æ³¨è¿™äº›åƒç´ ï¼‰
# - è¿œè·ç¦» â†’ å¼±äº¤äº’ï¼ˆQuery å¿½ç•¥è¿™äº›åƒç´ ï¼‰
```

**å…³é”®ä»£ç ä½ç½®**: [single_direction_issm_layer.py:138-139](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L138)

---

### ç¬¬ä¸‰æ­¥ï¼šåŠ¨æ€ç”Ÿæˆ SSM å‚æ•°

```python
# æ‹¼æ¥ Query ç‰¹å¾å’Œ 3D è·ç¦»
context = torch.cat([query_features, diff_3d], dim=-1)  # [B*N_q, L, D+3]

# é€šè¿‡ MLP ç”Ÿæˆå‚æ•°
params = param_gen(context)  # [B*N_q, L, d_state*2 + dt_rank]

# åˆ†ç¦»å‚æ•°
B_ssm, C_ssm, delta_proj = torch.split(params, [...], dim=-1)
delta = softplus(dt_proj(delta_proj))  # é—¨æ§å‚æ•°ï¼ˆä¿è¯ > 0ï¼‰
A = -exp(A_log)  # è¡°å‡å‚æ•°ï¼ˆä¿è¯ç¨³å®šæ€§ï¼‰
```

**ç‰©ç†æ„ä¹‰**:
- **B** (è¾“å…¥çŸ©é˜µ): æ§åˆ¶ Feature å¯¹ Query çš„**å½±å“å¼ºåº¦**
- **C** (è¾“å‡ºçŸ©é˜µ): æ§åˆ¶ Query å¯¹ Feature çš„**æ¿€æ´»æ¨¡å¼**
- **Î”** (é—¨æ§): æ§åˆ¶æ›´æ–°çš„**é€Ÿåº¦**ï¼ˆè·ç¦»è¿‘ â†’ Î”å¤§ â†’ æ›´æ–°å¿«ï¼‰
- **A** (çŠ¶æ€è½¬ç§»): æ§åˆ¶ Query è‡ªèº«çŠ¶æ€çš„**è®°å¿†è¡°å‡**

**å…³é”®ä»£ç ä½ç½®**: [single_direction_issm_layer.py:143-154](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L143)

---

### ç¬¬å››æ­¥ï¼šè¿è¡Œ SSM æ‰«æ

```python
# è¿è¡Œ SSM æ‰«æï¼ˆå¯¹åºåˆ—é€ä½ç½®å¤„ç†ï¼‰
scan_output, final_state = run_ssm_scan(
    x=features,              # è¾“å…¥åºåˆ—ï¼ˆFeatureï¼‰
    initial_state=queries,   # åˆå§‹éšçŠ¶æ€ï¼ˆQueryï¼‰
    delta=delta, A=A, B=B, C=C
)

# è¾“å‡ºï¼š
# - scan_output: [B*N_q, L, D]  æ¯ä¸ªä½ç½®çš„è¾“å‡ºï¼ˆå‡€åŒ–åçš„ Featureï¼‰
# - final_state: [B*N_q, D]     æœ€ç»ˆçŠ¶æ€ï¼ˆæ¼”è¿›åçš„ Queryï¼‰
```

#### SSM æ‰«æçš„å†…éƒ¨è¿‡ç¨‹ï¼ˆé€ä½ç½®å±•å¼€ï¼‰

```python
h = initial_state  # h_0 = Query

for t in range(L):  # éå†åºåˆ—ä¸­çš„æ¯ä¸ªåƒç´ 
    # çŠ¶æ€æ›´æ–°ï¼ˆQuery å¸æ”¶ Featureï¼‰
    h_t = exp(delta_t * A) * h_{t-1} + B_t * x_t
    
    # è¾“å‡ºç”Ÿæˆï¼ˆQuery æ¿€æ´» Featureï¼‰
    y_t = C_t * h_t
    
    outputs.append(y_t)

final_state = h_L  # æœ€ç»ˆçš„ Query çŠ¶æ€
scan_output = stack(outputs)  # æ‰€æœ‰ä½ç½®çš„è¾“å‡º
```

**å…³é”®ä»£ç ä½ç½®**: [single_direction_issm_layer.py:157-167](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L157)

---

### ç¬¬äº”æ­¥ï¼šQuery æ›´æ–°

```python
# å– SSM æ‰«æåçš„æœ€ç»ˆçŠ¶æ€
q_new = final_state.reshape(B, N_q, D)

# æŠ•å½± + æ®‹å·®è¿æ¥ + å½’ä¸€åŒ–
q_new = queries + dropout(out_proj_query(q_new))
q_new = layer_norm(q_new)
```

**æ›´æ–°åŸç†**:
- Query åœ¨æ‰«æ Feature åºåˆ—çš„è¿‡ç¨‹ä¸­ï¼Œ**é€æ­¥å¸æ”¶ç›¸å…³ä¿¡æ¯**
- è·ç¦»è¿‘çš„åƒç´ å¯¹ Query å½±å“å¤§ï¼ˆé€šè¿‡ B çŸ©é˜µå’Œ Î” é—¨æ§ï¼‰
- è·ç¦»è¿œçš„åƒç´ å½±å“å°æˆ–è¢«å¿½ç•¥
- æœ€ç»ˆ Query å˜æˆ**èåˆäº†ç©ºé—´ä¿¡æ¯çš„æ£€æµ‹çŠ¶æ€**

**ç‰©ç†æ„ä¹‰**: Query ä»"é”šç‚¹å‘¨å›´åº”è¯¥æœ‰ä»€ä¹ˆ"çš„**å‡è®¾**ï¼Œæ¼”è¿›ä¸º"å‘¨å›´ç¡®å®æœ‰ä»€ä¹ˆ"çš„**ç¡®ä¿¡**

**å…³é”®ä»£ç ä½ç½®**: [single_direction_issm_layer.py:174-176](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L174)

---

### ç¬¬å…­æ­¥ï¼šFeature æ›´æ–°

```python
# æ¯ä¸ª Query éƒ½äº§ç”Ÿäº† [L, D] çš„å“åº”
scan_output_reshaped = scan_output.reshape(B, N_q, L, D)

# èšåˆç­–ç•¥ï¼šå¯¹æ¯ä¸ªåƒç´ ï¼Œå–æ‰€æœ‰ Query çš„æœ€å¼ºå“åº”
f_aggregated = scan_output_reshaped.max(dim=1)[0]  # Max Pooling

# æŠ•å½± + æ®‹å·®è¿æ¥ + å½’ä¸€åŒ–
f_new = features + dropout(out_proj_feat(f_aggregated))
f_new = layer_norm(f_new)
```

**æ›´æ–°åŸç†**:
- æ¯ä¸ª Query åœ¨æ‰«ææ—¶ï¼Œé€šè¿‡ C çŸ©é˜µ**æ¿€æ´»**ä¸å…¶ç›¸å…³çš„ Feature
- è·ç¦»è¿‘çš„ Feature è¢«å¼ºçƒˆæ¿€æ´»
- è·ç¦»è¿œçš„ Feature å‡ ä¹ä¸è¢«æ¿€æ´»
- Max Pooling ä¿ç•™**æœ€å¼ºçš„æ¿€æ´»å“åº”**ï¼ˆå³æœ€ç›¸å…³çš„ç›®æ ‡ä¿¡æ¯ï¼‰

**ç‰©ç†æ„ä¹‰**: Feature ä»"åŒ…å«æ‰€æœ‰ä¿¡æ¯çš„åŸå§‹ç‰¹å¾"ï¼Œå‡€åŒ–ä¸º"çªå‡ºç›®æ ‡ç›¸å…³ä¿¡æ¯çš„å¢å¼ºç‰¹å¾"

**å…³é”®ä»£ç ä½ç½®**: [single_direction_issm_layer.py:178-181](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L178)

---

## ğŸ¨ å¯è§†åŒ–ç¤ºä¾‹

### å•ä¸ª Query çš„æ›´æ–°è¿‡ç¨‹

```
åˆå§‹çŠ¶æ€:
  Query (h_0) = [å…³äºæŸç›®æ ‡çš„åˆå§‹å‡è®¾]
  Feature     = [åŸå§‹å›¾åƒç‰¹å¾: èƒŒæ™¯ + å¤šä¸ªç›®æ ‡æ··æ‚]

â†“ æ‰«æä½ç½® 1 (è·ç¦» = 5mï¼Œè¿œ)
  delta_1 = 0.1 (å°) â†’ å¼±äº¤äº’
  h_1 = 0.9*h_0 + 0.1*x_1  (å‡ ä¹ä¸æ›´æ–°)
  y_1 = C_1*h_1            (å‡ ä¹ä¸æ¿€æ´»)

â†“ æ‰«æä½ç½® 2 (è·ç¦» = 0.5mï¼Œè¿‘)
  delta_2 = 0.8 (å¤§) â†’ å¼ºäº¤äº’
  h_2 = 0.2*h_1 + 0.8*x_2  (å¤§å¹…æ›´æ–°ï¼)
  y_2 = C_2*h_2            (å¼ºçƒˆæ¿€æ´»ï¼)

â†“ æ‰«æä½ç½® 3 (è·ç¦» = 3mï¼Œä¸­)
  delta_3 = 0.4 (ä¸­) â†’ ä¸­ç­‰äº¤äº’
  h_3 = 0.6*h_2 + 0.4*x_3
  y_3 = C_3*h_3

... (ç»§ç»­æ‰«ææ‰€æœ‰ä½ç½®)

æœ€ç»ˆçŠ¶æ€:
  Query (h_L) = [èåˆäº†æ‰€æœ‰ç›¸å…³ä¿¡æ¯çš„ç²¾ç¡®æ£€æµ‹çŠ¶æ€]
  Feature_new = stack([y_1, y_2, ..., y_L])
              = [çªå‡ºç›®æ ‡ä¿¡æ¯ï¼ŒæŠ‘åˆ¶èƒŒæ™¯çš„å‡€åŒ–ç‰¹å¾]
```

---

## ğŸ“Š å¯¹æ¯”ï¼šAttention vs ISSM

| ç‰¹æ€§ | Attention | ISSM |
|------|-----------|------|
| **Query è§’è‰²** | é™æ€æŸ¥è¯¢å‘é‡ | åŠ¨æ€æ¼”è¿›çŠ¶æ€ |
| **Feature è§’è‰²** | è¢«åŠ¨æŸ¥è¯¢å¯¹è±¡ | ä¸»åŠ¨å‚ä¸æ¼”è¿› |
| **äº¤äº’æ–¹å¼** | ç‚¹ç§¯ç›¸ä¼¼åº¦ | 3D è·ç¦»é©±åŠ¨ |
| **Query è¾“å‡º** | åŠ æƒæ±‚å’Œç»“æœ | æœ€ç»ˆçŠ¶æ€ h_L |
| **Feature è¾“å‡º** | ä¸å˜ | å‡€åŒ–åçš„ç‰¹å¾ |
| **å¤æ‚åº¦** | O(N_q Ã— L) | O(L) æ¯ä¸ª Query |
| **ç‰©ç†æ„ä¹‰** | "æˆ‘æƒ³è¦ä»€ä¹ˆ" | "æˆ‘åœ¨å“ª + å‘¨å›´æœ‰ä»€ä¹ˆ" |

---

## ğŸ” æ ¸å¿ƒä¼˜åŠ¿

### 1. è·ç¦»æ„ŸçŸ¥ï¼ˆSpatially-Awareï¼‰
- ä¼ ç»Ÿ Attention åªçœ‹ç‰¹å¾ç›¸ä¼¼åº¦
- ISSM ç»“åˆ **3D ç©ºé—´è·ç¦»** å’Œç‰¹å¾ç›¸ä¼¼åº¦
- æ›´ç¬¦åˆ 3D æ£€æµ‹çš„ç‰©ç†ç›´è§‰

### 2. åŒé‡æ¼”è¿›ï¼ˆDual Evolutionï¼‰
- Query ä¸æ–­å¸æ”¶ä¿¡æ¯ â†’ **æ£€æµ‹æ›´å‡†ç¡®**
- Feature è¢«é€æ­¥å‡€åŒ– â†’ **ä¸‹ä¸€å±‚æ›´é«˜æ•ˆ**

### 3. æ•ˆç‡æå‡ï¼ˆEfficientï¼‰
- Attention å¤æ‚åº¦: O(N_q Ã— L Ã— L)ï¼ˆå…¨å±€äº¤äº’ï¼‰
- ISSM å¤æ‚åº¦: O(N_q Ã— L)ï¼ˆçº¿æ€§æ‰«æï¼‰
- åœ¨é•¿åºåˆ—ï¼ˆå¤šè§†å›¾ï¼‰åœºæ™¯ä¸‹ä¼˜åŠ¿æ˜æ˜¾

---

## ğŸ’» ä»£ç è¿½è¸ªæŒ‡å—

å¦‚æœæƒ³æ·±å…¥ç†è§£ä»£ç å®ç°ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºé˜…è¯»ï¼š

1. **å…¥å£**: [issm_transformer.py:240-270](../../../mmdet3d_plugin/models/utils/issm_transformer.py#L240)
   - è§£ç å™¨çš„ä¸»å¾ªç¯
   - å¯†é›†èšåˆ + äº¤æ›¿æ‰«æ + ISSM å±‚è°ƒç”¨

2. **æ ¸å¿ƒå±‚**: [single_direction_issm_layer.py:117-186](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L117)
   - `forward()` æ–¹æ³•ï¼šå®Œæ•´çš„æ›´æ–°æµç¨‹
   - 3D è·ç¦»è®¡ç®—ã€å‚æ•°ç”Ÿæˆã€SSM æ‰«æ

3. **SSM å®ç°**: [single_direction_issm_layer.py:188-259](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L188)
   - `_run_issm_triton()`: Triton åŠ é€Ÿç‰ˆæœ¬
   - `_run_mamba_scan()`: Mamba åº“ç‰ˆæœ¬
   - `_run_scan_fallback()`: PyTorch åŸå§‹å®ç°

4. **å‚æ•°ç”Ÿæˆ**: [single_direction_issm_layer.py:74-84](../../../mmdet3d_plugin/models/utils/single_direction_issm_layer.py#L74)
   - `param_gen` MLP çš„å®šä¹‰
   - è¾“å…¥: [Query + 3Dè·ç¦»]ï¼Œè¾“å‡º: [B, C, Î”]

---

## ğŸ“ æ€»ç»“

**Query æ›´æ–° = Query é€šè¿‡ SSM å¸æ”¶ Feature ä¿¡æ¯**
- è¾“å…¥: åˆå§‹ Queryï¼ˆå‡è®¾ï¼‰
- è¿‡ç¨‹: æ‰«ææ‰€æœ‰åƒç´ ï¼Œè·ç¦»è¿‘çš„åƒç´ è´¡çŒ®å¤§
- è¾“å‡º: æ¼”è¿›åçš„ Queryï¼ˆç¡®ä¿¡ï¼‰

**Feature æ›´æ–° = Query æ¿€æ´»å¹¶å‡€åŒ– Feature**
- è¾“å…¥: åŸå§‹ Featureï¼ˆæ··æ‚ï¼‰
- è¿‡ç¨‹: æ¯ä¸ª Query æ¿€æ´»ç›¸å…³åŒºåŸŸï¼ŒæŠ‘åˆ¶æ— å…³åŒºåŸŸ
- è¾“å‡º: å‡€åŒ–åçš„ Featureï¼ˆèšç„¦ç›®æ ‡ï¼‰

**æ ¸å¿ƒæœºåˆ¶ = 3D è·ç¦»é©±åŠ¨çš„åŠ¨æ€å‚æ•°ç”Ÿæˆ**
- è·ç¦»å†³å®šäº¤äº’å¼ºåº¦
- æ¯ä¸ª Query-åƒç´ å¯¹éƒ½æœ‰ç‹¬ç«‹çš„ SSM å‚æ•°
- è‡ªåŠ¨å­¦ä¹ æœ€ä¼˜çš„äº¤äº’æ¨¡å¼

è¿™å°±æ˜¯ ISSM-StreamPETR çš„**åŒé‡æ¼”è¿›**æœºåˆ¶ï¼ğŸš€
